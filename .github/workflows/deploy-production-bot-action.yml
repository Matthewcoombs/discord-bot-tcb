name: Deploy Production Bot
on: [push]
env:
    REPO_NAME: ${{ github.event.repository.name }}
jobs:
    # Copying the copy project via sftp into the remote server
    deploy-via-sftp:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - id: SFTPDeploy
              uses: Creepios/sftp-action@v1.0.3
              with:
                username: root
                host: ${{ secrets.SSH_HOST }}
                port: 22
                privateKey:  ${{ secrets.SSH_PRIVATE_KEY }}
                localPath: '.'
                remotePath: /root/${{ env.REPO_NAME }}

    # Adding the discord bot token into the remote server
    add-bot-token:
        needs: [ deploy-via-sftp ]
        runs-on: ubuntu-latest
        timeout-minutes: 2
        env:
            BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        steps:
            - id: add-bot-token
              uses: fifsky/ssh-action@master
              with:
                command: |
                    cd ~
                    touch token.0
                    echo ${{ env.BOT_TOKEN }} > token.0
                    echo $?
                host: ${{ secrets.SSH_HOST }}
                user: root
                key: ${{ secrets.SSH_PRIVATE_KEY }}

    # Creating systemctl service to compile the project
    build-step:
        needs: [ deploy-via-sftp, add-bot-token]
        runs-on: ubuntu-latest
        timeout-minutes: 2
        steps:
            - id: build-step
              uses: fifsky/ssh-action@master
              with:
                command: |
                    cd /root/${{ env.REPO_NAME }}
                    tsc
                    echo $?
                host: ${{ secrets.SSH_HOST }}
                user: root
                key: ${{ secrets.SSH_PRIVATE_KEY }}

    # Creating systemctl service to start the bot
    # create-systemctl-service:
    #     needs: [add-bot-token, deploy-via-sftp]
    #     runs-on: ubuntu-latest
    #     steps:
    #         - id: create-systemctl-service
    #           uses: fifsky/ssh-action@master
    #           with:
    #             command: |
    #                 echo "[Unit]
    #                 Description=Production Discord Bot
    #                 After=multi.user.target
    #                 [Service]
    #                 Type=simple
    #                 WorkingDirectory=/root/${{ env.REPO_NAME }}/dist
    #                 ExecStart=/root/.nvm/versions/node/v20.4.0/bin/node index.js
    #                 User=root
    #                 Group=root
    #                 Restart=on-failure
    #                 RestartSec=30
    #                 [Install]
    #                 WantedBy=multi-user.target" >> /etc/systemd/system/start-bot.service
    #                 chmod +x /root/${{ env.REPO_NAME }}/dist/index.js
    #                 sudo systemctl enable start-bot.service
    #                 sudo systemctl daemon-reload
    #                 sudo systemctl start start-bot.service
    #             host: ${{ secrets.SSH_HOST }}
    #             user: root
    #             key: ${{ secrets.SSH_PRIVATE_KEY }}

